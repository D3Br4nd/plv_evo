services:
    init:
        image: alpine:latest
        command: >
            sh -c "mkdir -p /data/pgsql /data/redis &&
                   chmod -R 777 /data"
        volumes:
            - ./docker:/data
        user: root

    app:
        build:
            context: .
            dockerfile: Dockerfile
        restart: unless-stopped
        volumes:
            - '.:/app'
        env_file:
            - .env
        environment:
            SERVER_NAME: 'http://:8000'
        networks:
            - ${DOCKER_NETWORK:-plv_network}
        depends_on:
            init:
                condition: service_completed_successfully
            db:
                condition: service_healthy
            redis:
                condition: service_healthy

    db:
        image: 'postgres:18.1'
        restart: unless-stopped
        environment:
            POSTGRES_DB: '${DB_DATABASE:-plv_saas}'
            POSTGRES_USER: '${DB_USERNAME:-sail}'
            POSTGRES_PASSWORD: '${DB_PASSWORD:-password}'
        volumes:
            - './docker/pgsql:/var/lib/postgresql'
        networks:
            - ${DOCKER_NETWORK:-plv_network}
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-sail} -d ${DB_DATABASE:-plv_saas}"]
            interval: 10s
            timeout: 5s
            retries: 5

    redis:
        image: 'redis:8.4.0'
        restart: unless-stopped
        volumes:
            - './docker/redis:/data'
        command: redis-server --appendonly yes
        networks:
            - ${DOCKER_NETWORK:-plv_network}
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5

    reverb:
        build:
            context: .
            dockerfile: Dockerfile
        restart: unless-stopped
        command: php artisan reverb:start --host="0.0.0.0" --port=8080
        environment:
            APP_KEY: '${APP_KEY:-base64:xgH1qY6U+d9wYY3xZ8J7sK/8j4n9l1k0m2o3p4q5r6s=}'
            REVERB_APP_ID: '${REVERB_APP_ID:-app-id}'
            REVERB_APP_KEY: '${REVERB_APP_KEY:-app-key}'
            REVERB_APP_SECRET: '${REVERB_APP_SECRET:-app-secret}'
            REVERB_HOST: "0.0.0.0"
            REVERB_PORT: 8080
            REVERB_SCHEME: "http"
        volumes:
            - '.:/app'
        networks:
            - ${DOCKER_NETWORK:-plv_network}
        depends_on:
            init:
                condition: service_completed_successfully
            redis:
                condition: service_healthy
    
    vite:
        image: 'node:24.12.0'
        working_dir: /app
        command: sh -c "npm install && npm run dev"
        restart: unless-stopped
        volumes:
            - '.:/app'
        networks:
            - ${DOCKER_NETWORK:-plv_network}
        environment:
            VITE_HOST: '0.0.0.0'

networks:
    plv_network:
        external: true
        name: ${DOCKER_NETWORK:-plv_network}
